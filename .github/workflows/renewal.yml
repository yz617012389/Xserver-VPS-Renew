name: ğŸš€ XServer VPS è‡ªåŠ¨ç»­æœŸ

on:
  schedule:
    # æ¯72å°æ—¶ 00:00 UTC è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 */3 * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'ğŸ”„ å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: true
        default: 'true'
        type: choice
        options: ['false', 'true']

jobs:
  renewal:
    name: ğŸ”„ æ‰§è¡Œç»­æœŸä»»åŠ¡
    runs-on: ubuntu-latest
    permissions:
      contents: write

    # æä¾› FlareSolverr æœåŠ¡ï¼ˆä¿æŒä½ çš„è®¾ç½®ï¼‰
    services:
      flaresolverr:
        image: ghcr.io/flaresolverr/flaresolverr:latest
        ports:
          - 8191:8191
        env:
          LOG_LEVEL: info
          CAPTCHA_SOLVER: none

    # å…³é”®ï¼šç»™ Playwright çš„ headed æµè§ˆå™¨å‡†å¤‡è™šæ‹Ÿæ˜¾ç¤º
    env:
      DISPLAY: ":99"

    steps:
      # ========== ğŸ“¦ å‡†å¤‡é˜¶æ®µ ==========
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ğŸ§° å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆXvfb & X å·¥å…·ï¼‰
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils

      - name: â–¶ï¸ å¯åŠ¨ Xvfb è™šæ‹Ÿæ˜¾ç¤º
        run: |
          Xvfb :99 -screen 0 1920x1080x24 -ac +extension RANDR &
          for i in {1..15}; do
            if xdpyinfo >/dev/null 2>&1; then
              echo "âœ… Xvfb å·²å°±ç»ªï¼ŒDISPLAY=$DISPLAY"
              xdpyinfo | head -n 5 || true
              break
            fi
            echo "â³ ç­‰å¾… Xvfb å¯åŠ¨... ($i/15)"
            sleep 1
          done
          xdpyinfo >/dev/null 2>&1 || { echo "âŒ Xvfb å¯åŠ¨å¤±è´¥"; exit 1; }

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£… Python ä¾èµ–..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Python ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ğŸŒ å®‰è£… Playwright æµè§ˆå™¨å’Œä¾èµ–
        run: |
          echo "ğŸŒ å®‰è£… Chromium åŠç³»ç»Ÿä¾èµ–..."
          python -m playwright install --with-deps chromium
          echo "âœ… æµè§ˆå™¨å®‰è£…å®Œæˆ"

      # ========== ğŸ§ª æµ‹è¯• FlareSolverr è¿æ¥ ==========
      - name: ğŸ” æµ‹è¯• FlareSolverr æœåŠ¡
        run: |
          echo "ğŸ” æµ‹è¯• FlareSolverr è¿æ¥..."
          max_retries=10
          retry_count=0
          until curl -s http://localhost:8191/v1 > /dev/null || [ $retry_count -ge $max_retries ]; do
            retry_count=$((retry_count + 1))
            echo "â³ ç­‰å¾… FlareSolverr å¯åŠ¨... ($retry_count/$max_retries)"
            sleep 3
          done
          if [ $retry_count -ge $max_retries ]; then
            echo "âŒ FlareSolverr å¯åŠ¨å¤±è´¥"
            exit 1
          fi
          echo "âœ… FlareSolverr æœåŠ¡å·²å°±ç»ª"
          curl -s -X POST http://localhost:8191/v1 \
            -H "Content-Type: application/json" \
            -d '{"cmd":"sessions.list"}' | python3 -m json.tool

      # ========== ğŸš€ æ‰§è¡Œé˜¶æ®µ ==========
      - name: ğŸ¯ è¿è¡Œç»­æœŸè„šæœ¬ï¼ˆheaded + Xvfbï¼‰
        env:
          # ğŸ” è´¦å·ä¿¡æ¯
          XSERVER_EMAIL: ${{ secrets.XSERVER_EMAIL }}
          XSERVER_PASSWORD: ${{ secrets.XSERVER_PASSWORD }}
          XSERVER_VPS_ID: ${{ secrets.XSERVER_VPS_ID }}

          # ğŸ”§ FlareSolverr é…ç½®ï¼ˆä½¿ç”¨æœ¬åœ°æœåŠ¡ï¼‰
          FLARESOLVERR_URL: 'http://localhost:8191/v1'

          # ğŸ¤– éªŒè¯ç è¯†åˆ« APIï¼ˆå¯é€‰ï¼‰
          CAPTCHA_API_URL: ${{ secrets.CAPTCHA_API_URL }}

          # ğŸ“± Telegram é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          # âš™ï¸ å…¶ä»–è¿è¡Œé…ç½®
          PYTHONUNBUFFERED: "1"
          # æ³¨æ„ï¼šè„šæœ¬å†…éƒ¨ä¼šå¼ºåˆ¶ headless=Falseï¼Œè¿™é‡Œä¸è¦è®¾ç½® USE_HEADLESS=true ä»¥å…è¯¯å¯¼
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ XServer VPS è‡ªåŠ¨ç»­æœŸä»»åŠ¡..."
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ–¥ï¸ DISPLAY=$DISPLAY"
          xdpyinfo | head -n 3 || true

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ é…ç½®æ£€æŸ¥:"
          [ -n "$XSERVER_EMAIL" ] && echo "  âœ… XSERVER_EMAIL: å·²é…ç½®" || echo "  âŒ XSERVER_EMAIL: æœªé…ç½®"
          [ -n "$XSERVER_PASSWORD" ] && echo "  âœ… XSERVER_PASSWORD: å·²é…ç½®" || echo "  âŒ XSERVER_PASSWORD: æœªé…ç½®"
          [ -n "$XSERVER_VPS_ID" ] && echo "  âœ… XSERVER_VPS_ID: $XSERVER_VPS_ID" || echo "  âŒ XSERVER_VPS_ID: æœªé…ç½®"
          [ -n "$CAPTCHA_API_URL" ] && echo "  âœ… CAPTCHA_API_URL: å·²é…ç½®" || echo "  âš ï¸ CAPTCHA_API_URL: æœªé…ç½®ï¼ˆå°†ä½¿ç”¨é»˜è®¤ï¼‰"
          [ -n "$FLARESOLVERR_URL" ] && echo "  âœ… FlareSolverr: $FLARESOLVERR_URL" || echo "  âŒ FlareSolverr: æœªé…ç½®"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          [ -f "renewal.py" ] || { echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° renewal.py æ–‡ä»¶"; exit 1; }
          echo "ğŸ“‚ å½“å‰ç›®å½•: $(pwd)"
          ls -lh renewal.py

          python3 renewal.py

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ç»­æœŸä»»åŠ¡æ‰§è¡Œå®Œæˆ"

      # ========== ğŸ“Š ç»“æœå¤„ç† ==========
      - name: ğŸ“Š æ˜¾ç¤ºè¿è¡Œç»“æœ
        if: always()
        run: |
          echo "ğŸ“Š ========== è¿è¡Œç»“æœæ‘˜è¦ =========="
          [ -f "README.md" ] && cat README.md || true
          echo ""
          [ -f "cache.json" ] && cat cache.json | python3 -m json.tool || true
          echo ""
          echo "ğŸ“ æœ€æ–°æ—¥å¿—:"
          [ -f "renewal.log" ] && tail -n 200 renewal.log || true

      - name: ğŸ“¦ ä¸Šä¼ è¿è¡Œæ—¥å¿—ä¸æˆªå›¾
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: renewal-logs-${{ github.run_number }}
          path: |
            renewal.log
            *.png
            cache.json
          retention-days: 30

      - name: ğŸ’¾ æäº¤çŠ¶æ€æ›´æ–°
        if: always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot ğŸ¤–"
          [ -f "README.md" ] && git add README.md || true
          [ -f "cache.json" ] && git add cache.json || true
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ— éœ€æäº¤"
          else
            git commit -m "ğŸ”„ çŠ¶æ€æ›´æ–° [skip ci]"
            git push
          fi

  stats:
    name: ğŸ“ˆ æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    runs-on: ubuntu-latest
    needs: renewal
    if: always()
    steps:
      - name: ğŸ“Š è¿è¡Œç»Ÿè®¡
        run: |
          echo "ğŸ“ˆ ========== XServer VPS ç»­æœŸç»Ÿè®¡ =========="
          echo "ğŸ”¢ è¿è¡Œæ¬¡æ•°: #${{ github.run_number }}"
          echo "â° æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
